# Push Notification Service Overview

Push notifications facilitate the developer to push messages or notifications to users. Keeping interactions with users helps to retain the customers and to improve the user experience. Leancloud integrates Android Push and iOS Push into one service.

In addition to the iOS and Android SDKs, you can take advantage of [REST API](#push-notifications-rest-api) to send push notifications.

To use push notifications, you need to enable it in [Dashboard > Settings > Security > Service switches](https://console.leancloud.app/app.html?appid={{appid}}#/security) first.

## Basic Concepts

### Installation

An installation uniquely identifies a device with push notifications enabled.
Installations are stored in the `_Installation` table.
An installation is just a normal object containing the following attributes:

Attributes | Platform | Description
---|---|---
badge|iOS| number shown on the top right corner of the application icon, which may represent unread messages
channels||array of the channels subscribed
deviceProfile||When your application has multiple iOS push certificates or multiple Android mixpush configurations, you can use `deviceProfile` to specify the current certificate or configuration. Its value has to align with the value in [Dashboard > Messaging > Push notifications > Settings](messaging.html?appid={{appid}}#/message/push/conf), otherwise, the push will fail. `deviceProfile` must be an empty string or a string that begins with a letter, and only contains letters, numbers, and underscores.
deviceToke|iOS|a unique identifier assigned by Apple for APNS
ansTopic|iOS|This is required for push notifications based on Token Authentication. iOS SDKs will automatically use the bundle ID of the iOS application as `apnsTopic`. However, you have to manually specify them under the following circumstances: 1. iOS SDK version is earlier than v4.2.0 2. not using iOS SDK (for example, you are developing a React Native application) 3. using a `topic` different from bundle ID.
deviceType|| `ios` or `android`
installationId|Android| a unique device identifier generated by LeanCloud SDK
subscriptionUri |Windows Phone|MPNS (Microsoft Push Notification Service) Push channel
timeZone||a string indicating the device timezone

### Notification

A notification corresponds to an entry in [Dashboard > Messaging > Push notification > History](messaging.html?appid={{appid}}#/message/push/list).
It includes the following attributes:

Attributes | Platform | Description
---|---|---
data| |Push content (a JSON object).
invalidTokens|iOS|The number of returned [INVALID TOKEN](https://developer.apple.com/library/mac/technotes/tn2265/_index.html#//apple_ref/doc/uid/DTS40010376-CH1-TNTAG32) from the APNs for this push. **If this number is very large, please check if the certificate is valid.**
prod|iOS|The certificate of the environment to use. **dev** represents a development certificate, **prod** represents a production certificate.
status| |Push status. Its value may be one of **in-queue** (still in the queue), **done** (pushed) or **scheduled** (scheduled notification to be pushed).
devices| |The number of targets. This number is not the number of devices successfully pushed, but the number of devices valid for the query of installations. **Valid** means the `valid` attribute of the installation is true and its `updatedAt` attribute is within three months. This number may include a lot of inactive users (for example, users who have already uninstalled the application), and these users may not be able to receive notifications.
successes | |The number of successfully pushed devices. "Successfully pushed" refers to the device successfully received the notification or the notification has been delivered to the upstream push service such as Apple's APNS or Android's FCM.
where| |Query conditions of installations for this push. Devices matching the specified conditions will receive the notification.
errors| |Error message.

The essence of "push" is querying for all the devices matching some specific conditions, then pushing a message to these devices.
As installation is a fully customizable object, you can easily implement pushes with various complex conditions, such as pushing to users subscribed to certain channels, users located in certain places, etc.

When `devices` has a value of 0, there are no devices matching the query conditions specified.
Thus you need to examine the query conditions.
When `devices` has a value larger than 0, it only means devices matching the query conditions exist.
It is not guaranteed these devices will all receive the notifications pushed,
thus it is reasonable to have **devices** larger than **successes**.
And their difference may be large when there are enormous inactive devices.

Changing the attribute `valid` of installation to `false` will disable push notification for that device.

Note that LeanCloud only retains the push history for one week and the expired push history will get cleared.
There is no relation between the expiration of the notification and the expiration of the push history.
The targeted devices will still receive the notification pushed to them nonetheless the push history has been cleared.
Refer to the [notification expiration](#notification-expiration) section for more information on the expiration of notification itself.

{# TODO 

## iOS Push Notification

Refer to [iOS push guide](./ios_push_guide.html).

## Android Push Notification

Refer to [Android push guide](./android_push_guide.html).

## Android Mix Push

We designed an advanced push mechanism named [mix push] to lift up the push rate on some Android device with more restrictive background process management. 

The function is only available for Business Plan users, switch on the function in [Dashboard > Messaging > Push Notification > Settings > mix push](/dashboard/messaging.html?appid={{appid}}#/message/push/conf), switch on the mix push.

Attention, **Swtich on Push Notification** option can adjust at discretion without any adversity. When it is switched off, the next Android Push will work as the normal push via the LeanCloud owned channel to the client terminal. Nothing is changed but the push may get influenced by some background process management. However, the third party channel will get utilized if the mix push is switched on.

Refer to [Android mix push guide](./android_push_guide.html#Mix Push).

#}

## Send Notification under LeanEngine in JavaScript

Please refer to the [Push Notifications] section of the [LeanStorage JavaScript Guide](leanstorage_guide-js.html#push-notifications).

## REST API Push Notification 

### Installation

Once your application has been installed on users' devices, LeanCloud SDKs will automatically generate an installation object for you.
The installation object contains all the information required by push notifications.
You can use REST API to push notifications to installations specified.

#### Creating Installations

Creating an installation is similar to [create a normal object](rest_api.html#creating-objects).
Also, its response is the same as creating a normal object.
An installation contains different attributes on different platforms, though.

##### DeviceToken

iOS devices use DeviceToken:

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{appkey}}"        \
  -H "Content-Type: application/json" \
  -d '{
        "deviceType": "ios",
        "deviceToken": "abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789",
        "channels": [
          "public", "protected", "private"
        ]
      }' \
  https://{{host}}/1.1/installations
```


##### installtionId

For Android devices, the LeanCloud SDK will automatically generate a unique ID (`installationId`) and save it in the cloud.

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{appkey}}"        \
  -H "Content-Type: application/json" \
  -d '{
        "deviceType": "android",
        "installationId": "12345678-4312-1234-1234-1234567890ab",
        "channels": [
          "public", "protected", "private"
        ]
      }' \
  https://{{host}}/1.1/installations
```

`installationId` should always be unique within the given application.

### Retrieving Installations

You can retrieve an installation just as [retrieving a normal object](rest.html#retrieving-objects):

```sh
curl -X GET \
  -H "X-LC-Id: {{appid}}" \
  -H "X-LC-Key: {{appkey}}" \
  https://{{host}}/1.1/installations/51ff1808e4b074ac5c34d7fd
```

The JSON object returned:

```json
{
  "deviceType": "ios",
  "deviceToken": "abcdefghijklmnopqrstuvwzxyrandomuuidforyourdevice012345678988",
  "channels": [
    ""
  ],
  "createdAt": "2012-04-28T17:41:09.106Z",
  "updatedAt": "2012-04-28T17:41:09.106Z",
  "objectId": "51ff1808e4b074ac5c34d7fd"
}
```

### Updating Installations

You can update an installation just as [updating a normal object](rest.html#updating-objects).

For example, to subscribe to a channel named "foo":

```sh
curl -X PUT \
  -H "X-LC-Id: {{appid}}" \
  -H "X-LC-Key: {{appkey}}" \
  -H "Content-Type: application/json" \
  -d '{
        "deviceType": "ios",
        "deviceToken": "abcdefghijklmnopqrstuvwzxyrandomuuidforyourdevice012345678988",
        "channels": [
          "",
          "foo"
        ]
      }' \
  https://{{host}}/1.1/installations/51ff1808e4b074ac5c34d7fd
```

Or to unsubscribe a channel:

```sh
curl -X PUT \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{appkey}}"        \
  -H "Content-Type: application/json" \
  -d '{
        "channels": {
           "__op":"Remove",
           "objects":["customer"]
        }
       }' \
  https://{{host}}/1.1/installations/51ff1808e4b074ac5c34d7fd
```

In essence, `channels` is an array.
Therefore, it conforms to standard [REST API operations](./rest_api.html#arrays).

You can also add customized attributes to an installation:

```sh
curl -X PUT \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{appkey}}"        \
  -H "Content-Type: application/json" \
  -d '{
        "userObjectId": "<user objectId>"
      }' \
  https://{{host}}/1.1/installations/51ff1808e4b074ac5c34d7fd 
```

### Installation Queries

Similar to normal objects, you can send a GET request to `installations` list all installations.
This only works in the REST API, and there is no equivalent APIs in client-side SDKs.

```sh
curl -X GET \
  -H "X-LC-Id: {{appid}}" \
  -H "X-LC-Key: {{appkey}}" \
  https://{{host}}/1.1/installations
```

A `results` array (wrapped in an object) will be returned:

```json
{
  "results": [
    {
      "deviceType": "ios",
      "deviceToken": "abcdefghijklmnopqrstuvwzxyrandomuuidforyourdevice012345678988",
      "channels": [
        ""
      ],
      "createdAt": "2012-04-28T17:41:09.106Z",
      "updatedAt": "2012-04-28T17:41:09.106Z",
      "objectId": "51ff1808e4b074ac5c34d7fd"
    },
    {
      "deviceType": "ios",
      "deviceToken": "876543210fedcba9876543210fedcba9876543210fedcba9876543210fedcba9",
      "channels": [
        ""
      ],
      "createdAt": "2012-04-30T01:52:57.975Z",
      "updatedAt": "2012-04-30T01:52:57.975Z",
      "objectId": "51fcb74ee4b074ac5c34cf85"
    }
  ]
}
```

All the queries applicable to normal objects are also applicable to installations.
By querying the `channels` array, you can retrieve all the devices subscribed to a given channel.

### Deleting Installations

You can delete an installation just as [deleting a normal object](rest_api.html#deleting-objects).
This is also only available in REST API.
There is no equivalent APIs in client-side SDKs.

```sh
curl -X DELETE \
  -H "X-LC-Id: {{appid}}" \
  -H "X-LC-Key: {{appkey}}" \
  https://{{host}}/1.1/installations/51fcb74ee4b074ac5c34cf85
```

### Push Notifications

#### Master Key

By default, you have to use the master key (`X-LC-Key: {{masterkey}},master`) to send push notifications.
If you want to allow your application users to send push notifications to each other, you can disable the **Prevent clients from sending push notifications** option in [Dashboard > Messaging > Push notifications > Settings](/messaging.html?appid={{appid}}#/message/push/conf).
This is insecure thus we recommend to keep this restriction on.

#### Query Then Push

This interface is used to push notifications to all the devices matching specific conditions.
For example, to push notifications to all the devices in the "public" channel:

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{masterkey}},master"        \
  -H "Content-Type: application/json" \
  -d '{
        "where": {"channels" : ["public"]},
        "data": {"alert" : "Hello from LeanCloud"}
     }' \
  https://{{host}}/1.1/push
```

Note that the HTTP body (namely the serialized JSON object passed in) must be no larger than 4096 bytes.

The parameters available are as follows:

Name | Optionality | Description 
--- | --- | ---
data| **required** | A JSON object of notification content.{#TODO refer to [消息内容](#消息内容_Data) #}
where | optional | The conditions to query the `_installation` table. See also descriptions on how to encode [Advanced data types](rest_api.html#advanced-data-types).
channels | optional | Included as a condition in the `where` parameter.
expiration_interval | optional | Expiration time in ***second**, relative to the moment the API is invoked.
expiration_time | optional | The absolute expiration time in ISO8691 format with `UTC+0` timezone, e.g. `2019-04-01T06:19:29.000Z`.
notification_id | optional | Customizable push notification id. It is a string consist of up to 16 alphanumeric characters. If not specified, an auto-generated random id will be used. Targets and successes are calculated based on this id, as displayed in [Notification History on Dashboard](#Notification). Specifying a `notification_id` allows for developers to accumulate targets and successes of push notifications for multiple requests.
push_time | optional | A ISO8601 timestamp string with timezone `UTC+0` used for scheduled push. The notification will be pushed immediately if the `push_time` is in less than one minute. You can implement cyclical pushes using [LeanEngine](https://docs.leancloud.app/leanengine_overview.html).
req_id | optional | Customizable request id. Similar to `notification_id`, it is a string consist of up to 16 alphanumeric characters. Requests with an identical `req_id` in five minutes will be treated as duplication and LeanCloud will only handle one of them. You can specify this parameter when you plan to retry requests on timeout errors. **Retrying too frequently or too much will interfere with normal pushes**. Please be careful.
prod | optional |**Only applicable for iOS devices.** When using Token Authentication, you can use this parameter to specify whether the notifications will be pushed to the `dev` environment or `prod` environment of APNs. When using certificate authentication, you can use this parameter to specify whether using a `dev` certificate or a `prod` certificate. The `deviceProfile` attribute of the installation takes precedence over this parameter.
topic | optional | **Only applicable for pushing to iOS devices with the Token Authentication.** The APNs Topic is required for Token Authentication. iOS SDKs will automatically use the bundle ID of the iOS application as `apnsTopic`. However, you have to manually specify them under the following circumstances: 1. iOS SDK version is earlier than v4.2.0 2. not using iOS SDK (for example, you are developing a React Native application) 3. using a `topic` different from bundle ID.
apns_team_id | **Only applicable for pushing to iOS devices with the Token Authentication.**  The Team ID is required for Token Authentication. Generally, if there are no duplicated APNs Topics for all of your Team IDs, or if you have specified the `apnsTeamId` attribute of the installation beforehand, then LeanCloud will automatically push notifications with the Team ID matched. Otherwise, you need to manually specify this parameter and ensure all the targeted devices have the specified Team ID.
flow_control | optional | Targets per second. If specified, LeanCloud will throttle the pushes. The minimum value is 1000, if a value less than 1000 is specified, it will be treated as 1000.

Below are examples of some common use cases.
Refer to [Queries](rest_api.html#queries) section for more information.

##### Push to All Devices

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{masterkey}},master"        \
  -H "Content-Type: application/json" \
  -d '{
        "data": {
          "alert": "LeanCloud greetings！"
        }
      }' \
  https://{{host}}/1.1/push
```

##### Push to Android Devices

* to Andorid users

```sh
curl -X POST \
-H "X-LC-Id: {{appid}}"          \
-H "X-LC-Key: {{masterkey}},master"        \
-H "Content-Type: application/json" \
-d '{
      "where":{
        "deviceType": "android"
      },
      "data": {
        "alert": "LeanCloud greetings！"
      }
    }' \
https://{{host}}/1.1/push
```

##### Push to Devices Subscribed to the `public` Channel

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{masterkey}},master"        \
  -H "Content-Type: application/json" \
  -d '{
        "channels":["public"],
        "data": {
          "alert": "LeanCloud greetings！"
        }
      }' \
  https://{{host}}/1.1/push
```

##### Push to Inactive Devices

```sh
curl -X POST \
-H "X-LC-Id: {{appid}}"          \
-H "X-LC-Key: {{masterkey}},master"        \
-H "Content-Type: application/json" \
-d '{
      "where":{
          "updatedAt":{
              "$lt":{"__type":"Date","iso":"2015-06-29T11:33:53.323Z"}
            }
      },
      "data": {
          "alert": "LeanCloud greetings！"
      }
    }' \
https://{{host}}/1.1/push
```

##### Push to Devices with Specific Custom Attributes

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{masterkey}},master"        \
  -H "Content-Type: application/json" \
  -d '{
        "where": {
          "preOrder": true
        },
        "data": {
          "alert": "New Arrivals!"
        }
      }' \
  https://{{host}}/1.1/push
```

##### Push to Devices Nearby

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{masterkey}},master"        \
  -H "Content-Type: application/json" \
  -d '{
        "where": {
          "owner": {
            "$inQuery": {
              "location": {
                "$nearSphere": {
                  "__type": "GeoPoint",
                  "latitude": 30.0,
                  "longitude": -20.0
                },
                "$maxDistanceInMiles": 10.0
              }
            }
          }
        },
        "data": {
          "alert": "Heat Alert!"
        }
      }' \
  https://{{host}}/1.1/push
```

#### Push Notifications with Device ID List

You can also directly specify a list of devices as push targets.
This may be faster than the query then push approach mentioned above.

```sh
curl -X POST \
  -H "X-LC-Id: {{appid}}"          \
  -H "X-LC-Key: {{masterkey}},master"        \
  -H "Content-Type: application/json" \
  -d '{
        "data": {"alert" : "Hello from LeanCloud"},
        "device_type": "ios",
        "device_ids": ["device_token1", "device_token2", "device_token3"]
     }' \
  https://{{host}}/1.1/push/devices
```

Platform independent parameters of this interface are as follows:

Name | Optionality | Description
--- | --- | ---
device_type | **required** | `android` or `iOS`.
device_ids | **required** | The target device ID List, 500 at maximum. For iOS devices, device ID is the `deviceToken` attribute of the installation. For Android devices, device ID is the `registrationId` attribute (with FCM) or the `installationId` attribute (without FCM).
data| **required** | See the [Query Then Push](#query-then-push) section above.
expiration_interval | optional | See above.
expiration_time | optional | See above.
notification_id | optional | See above.
req_id | optional | See above.

Parameters for iOS devices are as follows:

Name | Optionality | Description
---- | ---- | ----
prod | optional | See the [Query Then Push](#query-then-push) section above. 
topic | optional | See above.
anpns_team_id | optional | See above.
device_profile | optional | Custom push certificate for iOS devices. When using Token Authentication, or when using a configured dev/prod certificate, LeanCloud will automatically choose the certificate based on the `prod` parameter.

Parameters for Android devices are as follows:

Name | Optionality | Description
---- | ---- | ----
channel | optional | Android notification channel.
vendor | optional | `fcm` if using FCM.

{# TODO

### Expiry Time

We suggest iOS devices should all have expiry time, this can allow the receiver to reconnect to the server and get the push even though temporary disconnetion. Refer to [Stackoverflow &middot; Push notification is not being delivered when iPhone comes back online](http://stackoverflow.com/questions/24026544/push-notification-is-not-being-delivered-when-iphone-comes-back-online)。

and 

[Expiry time and fixed time push](#Expiry Time and Fixed Time Push)

#}

#### Message Content

#### iOS Devices

For iOS devices, the notification content (passed in the `data` parameter) should be wrapped in a JSON object with an `aps` key:

```json
{
  "aps": {
     "alert": {
       "title":               "notification title",
       // ... and other APNs payload keys
     }
     // ... and other APNs payload keys
   },
   "collapse-id":          "`apns-collapse-id` request header",
   "apns-priority":        "`apns-priority` request header",
   "apns-push-type":       "One of `background`, `voip`, `complication`, `fileprovider`, `mdm`, and `alert`. Default value: `alert`",
   "custom-key":           "arbitrary key specifed by developers"
}
```

Please refer to [official](ttps://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/generating_a_remote_notification) [Apple](https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingwithAPNs.html) [documentation](https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingwithAPNs.html) for details.

#### Android Devices

For Android devices, the default fields are as follows:

```json
{
  "alert": "string, notification content",
  "title": "string, notification titile",
  "silent": "boolean, disabling the notification center alert, defaults to false",
  "custom-key": "arbitrary key specifed by developers",
  "action": "string, if you want to customize the Receiver"
}
```

To customize the Receiver, set the `action` field:

```
{
  "alert": string, content of the push
  "title": string, title in the notification centre
  "action": string, action name for registering Receiver
  "silent": boolean, mute the notificaiton or not, default on false
  "custom-key": self-customized field, switch at discretion  
}

{# TODO For customize Receiver refer to [customize Receiver](./android_push_guide.html#customize_Receiver). #}

#### Mixing Device Types

{# TODO
For a single push, if the query have several different device types, we can retrieve the matching device type to push. For example:

```
{
  "ios": {
    "alert":             "Hello iOS",
    "badge":             "Increment",
    "custom-key":        "custom-value"
  },
  "android": {
    "alert":             "Hello LeanCloud",
    "action":            "com.your_company.push",
    "custom-key":        "custom-value"
  },
  "mi": {
    "alert":             "Hello Mi",
    "custom-key":        "custom-value"
  },
  "hms": {
    "alert":             "Hello Huawei",
    "custom-key":        "custom-value"
  }
}
```

The name and the matching platform is as follows:

name | platform
-------- | ----
ios | Apple APNs
android | Android from LeanCloud
mi | Xiaomi
hms | Huawei 
mz | meizu
vivo | -
oppo | -

#}

{#TODO 

#### iOS 测试和生产证书区分

我们现在支持上传两个环境的 iOS 推送证书：测试和生产环境，你可以通过设定 `prod` 属性来指定使用哪个环境证书。

```
{
  "prod": "dev",
  "data": {
    "alert": "test"
  }
}
```

如果是 `dev` 值就表示使用开发证书，`prod` 值表示使用生产证书。如果未设置 `prod` 属性，且使用的不是 [JavaScript 数据存储 SDK](https://leancloud.github.io/javascript-sdk/docs/AV.Push.html)，我们默认使用**生产证书**来发推送。如果未设置 `prod` 属性，且使用的是 [JavaScript 数据存储 SDK](https://leancloud.github.io/javascript-sdk/docs/AV.Push.html) ，则需要在发推送之前执行 [AV.setProduction](https://leancloud.github.io/javascript-sdk/docs/AV.html#.setProduction) 函数才会使用生产证书发推送，否则会以开发证书发推送。注意，当设备设置了 `deviceProfile` 时我们优先按照 `deviceProfile` 指定的证书推送。

#### Android 推送区分透传和通知栏消息

Android 推送（包括 Android 混合推送）支持透传和通知栏两种消息类型。透传消息是指消息到达设备后会先交给 LeanCloud Android SDK，再由 SDK 将消息通过 [自定义 Receiver](./android_push_guide.html#自定义_Receiver) 传递给开发者，收到消息后的行为由开发者定义的 Receiver 来决定，SDK 不会自动弹出通知栏提醒。而通知栏消息是指消息到达设备后会立即自动弹出通知栏提醒。

LeanCloud 推送服务通过推送请求中 `data` 参数内的 `silent` 字段区分透传和通知栏消息。如果 `silent` 是 `true` 则表示这个消息是透传消息，为 `false` 表示消息是通知栏消息。如果不传递 `silent` 则默认其值为 `false`。另外请注意，如果希望接收透传消息请不要忘记自行实现 [自定义 Receiver](./android_push_guide.html#自定义_Receiver)。

推送请求中的 `data` 参数请参考 [消息内容 Data](#消息内容_Data)。

#### Android 混合推送多配置区分

如果使用了混合推送功能，并且在 [控制台 > 消息 > 推送 > 设置 > 混合推送](/dashboard/messaging.html?appid={{appid}}#/message/push/conf) 增加了多个混合推送配置，那么在向 `_Installation` 表保存设备信息时就需要将当前设备所对应的混合推送配置名存入 `deviceProfile` 字段。系统会按照该字段指定的唯一配置名为每个目标设备进行混合推送。

如果 `deviceProfile` 字段为空，系统会默认使用名为 `_default` 的混合推送配置来进行推送，所以一定要保证在控制台的混合推送设置中，存在以 `_default` 命名的 Profile 并且已被正确配置，否则系统会**拒绝推送。**

{{deviceprofile_format}}



#}

